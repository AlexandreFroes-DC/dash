<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ASPAD / MJSP</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.29.0.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 18px; background: #f7f7f7; color: #222; }
    h2 { margin-bottom: 12px; }
    .filtros { margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 8px; align-items:center; }
    .filtros label { font-weight:600; margin-right:4px; }
    .filtros select, .filtros button { padding:6px 10px; border-radius:6px; border:1px solid #cfcfcf; }
    .filtros button { background:#007BFF; color:#fff; cursor:pointer; border:none; }
    .filtros button:hover { background:#0056b3; }

    .acoes { margin: 12px 0; display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .acoes select, .acoes button { padding:6px 10px; border-radius:6px; border:1px solid #cfcfcf; }
    .acoes button { background:#28a745; color:#fff; cursor:pointer; border:none; }
    .acoes button:hover { background:#1e7e34; }

    #graficos { display:flex; flex-direction:column; gap:18px; width:100%; }
    #graficos > div { min-height:300px; background:#fff; border-radius:6px; padding:8px; }

    #tabela-container { background:#fff; border-radius:6px; padding:8px; margin-top:16px; }
    #contador { margin-bottom:8px; font-weight:600; }

    #analise-ia { background:#fff; border-radius:6px; padding:12px; margin-top:16px; }
    #analise-ia em { color:#555; }

    #btnIA {
      margin-top:10px;
      background:#6f42c1;
      color:#fff;
      padding:8px 14px;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    #btnIA:hover { background:#563d7c; }

    .loader {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid #ccc;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-left: 8px;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    @page { size: A4 landscape; margin: 10mm; }
    @media print {
      body * { visibility: hidden; }
      #graficos, #graficos * { visibility: visible; }
      #graficos { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
</head>
<body>
  <h2>üìä Dashboard ASPAD / MJSP</h2>

  <!-- filtros -->
  <div class="filtros" id="filtros-area">
    <label for="ano">Ano:</label>
    <select id="ano"><option value="">Todos</option></select>

    <label for="fornecedor">Fornecedor:</label>
    <select id="fornecedor"><option value="">Todos</option></select>

    <label for="pais">Pa√≠s:</label>
    <select id="pais"><option value="">Todos</option></select>

    <button id="btnLimpar">Limpar</button>
  </div>

  <!-- a√ß√µes -->
  <div class="acoes">
    <label for="formato">Salvar como:</label>
    <select id="formato">
      <option value="png">PNG</option>
      <option value="jpeg">JPEG</option>
      <option value="svg">SVG</option>
      <option value="pdf">PDF</option>
    </select>
    <button id="btnSalvar">üíæ Salvar Gr√°ficos</button>
    <button id="btnImprimir">üñ®Ô∏è Imprimir Gr√°ficos</button>
  </div>

  <!-- gr√°ficos -->
  <div id="graficos">
    <div id="graficoPais"></div>
    <div id="graficoMes"></div>
    <div id="graficoFornecedor"></div>
    <div id="graficoRisco"></div>
  </div>

  <!-- tabela -->
  <div id="tabela-container">
    <h3>üìã Tabela Recall</h3>
    <div id="contador"></div>
    <table id="tblRecall" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Data In√≠cio</th><th>Data Fim</th><th>T√≠tulo</th><th>Fornecedor</th>
          <th>Risco</th><th>Pa√≠s</th><th>Produto</th>
          <th>Total Afetado</th><th>Total Atendido</th><th>% Atendido</th>
        </tr>
      </thead>
      <tbody id="dadosTabela"></tbody>
    </table>
  </div>

  <!-- an√°lise IA -->
  <div id="analise-ia"><em>üß† Aguardando an√°lise inteligente...</em></div>
  <button id="btnIA">üîÑ Atualizar An√°lise IA</button>

<script>
(async function(){
  let baseDados = [];
  const mesesOrdem = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  const selAno = document.getElementById('ano');
  const selFornecedor = document.getElementById('fornecedor');
  const selPais = document.getElementById('pais');
  const btnLimpar = document.getElementById('btnLimpar');

  async function carregarDados() {
    try {
      const res = await fetch('campanhas_recall.json');
      const json = await res.json();
      const tableNode = json.find(e => e.type === 'table');
      if(!tableNode || !Array.isArray(tableNode.data)) throw new Error('Formato JSON inesperado');

      baseDados = tableNode.data.map(d => {
        const dataIni = d.data_inicio ? new Date(d.data_inicio) : null;
        const afetado = Number(d.total_afetado) || 0;
        const atendido = Number(d.total_atendido) || 0;
        return {
          id: d.id || '',
          data_inicio: d.data_inicio || '',
          data_fim_campanha: d.data_fim_campanha || '',
          titulo: d.titulo || '',
          fornecedor: d.fornecedor || '(Sem valor)',
          tipo_risco: d.tipo_risco || '(Sem valor)',
          pais_origem: d.pais_origem || '(Sem valor)',
          produto: d.produto || '',
          total_afetado: afetado,
          total_atendido: atendido,
          perc_atendido: afetado>0 ? ((atendido/afetado)*100).toFixed(1) : '0',
          ano: dataIni ? dataIni.getFullYear() : '(Sem valor)',
          mes: dataIni ? mesesOrdem[dataIni.getMonth()] : '(Sem valor)'
        };
      });

      preencherFiltros();
      atualizarTudo(baseDados);
    } catch(err) {
      console.error('Erro ao carregar dados:', err);
      alert('Erro ao carregar dados. Veja o console para detalhes.');
    }
  }

  function preencherFiltros() {
    const anos = [...new Set(baseDados.map(d=>d.ano).filter(Boolean))].sort((a,b)=>a-b);
    const fornecedores = [...new Set(baseDados.map(d=>d.fornecedor).filter(Boolean))].sort();
    const paises = [...new Set(baseDados.map(d=>d.pais_origem).filter(Boolean))].sort();
    anos.forEach(a => { const o=document.createElement('option'); o.value=a; o.textContent=a; selAno.appendChild(o); });
    fornecedores.forEach(f => { const o=document.createElement('option'); o.value=f; o.textContent=f; selFornecedor.appendChild(o); });
    paises.forEach(p => { const o=document.createElement('option'); o.value=p; o.textContent=p; selPais.appendChild(o); });
  }

  function obterFiltrados() {
    const anoFiltro = selAno.value;
    const fornecedorFiltro = selFornecedor.value;
    const paisFiltro = selPais.value;
    return baseDados.filter(d =>
      (!anoFiltro || String(d.ano)===String(anoFiltro)) &&
      (!fornecedorFiltro || d.fornecedor===fornecedorFiltro) &&
      (!paisFiltro || d.pais_origem===paisFiltro)
    );
  }

  function atualizarTudo(dados){
    gerarGraficos(dados);
    preencherTabela(dados);
    gerarAnaliseIA(dados);
  }

  function gerarGraficos(dados){
    const config = {responsive:true};
    const porPais = agrupar(dados,'pais_origem');
    Plotly.newPlot('graficoPais',[{x:Object.keys(porPais),y:Object.values(porPais),type:'bar',marker:{color:'#4c78a8'}}],{title:'Distribui√ß√£o por Pa√≠s',margin:{t:40}},config);

    const porMes = agrupar(dados,'mes');
    const meses = mesesOrdem.filter(m => porMes[m] !== undefined);
    Plotly.newPlot('graficoMes',[{x:meses,y:meses.map(m=>porMes[m]),type:'bar',marker:{color:'#f58518'}}],{title:'Distribui√ß√£o por M√™s',margin:{t:40}},config);

    const porFornecedor = agrupar(dados,'fornecedor');
    const listFor = Object.entries(porFornecedor).sort((a,b)=>b[1]-a[1]).slice(0,10);
    Plotly.newPlot('graficoFornecedor',[{x:listFor.map(x=>x[0]),y:listFor.map(x=>x[1]),type:'bar',marker:{color:'#54a24b'}}],{title:'Top Fornecedores (Top 10)',margin:{t:40,b:120}},config);

    const porRisco = agrupar(dados,'tipo_risco');
    Plotly.newPlot('graficoRisco',[{labels:Object.keys(porRisco),values:Object.values(porRisco),type:'pie'}],{title:'Classifica√ß√£o de Risco',margin:{t:40}},config);
  }

  function preencherTabela(dados){
    const tbody = document.getElementById('dadosTabela');
    tbody.innerHTML = dados.map(d=>`
      <tr>
        <td>${d.data_inicio}</td>
        <td>${d.data_fim_campanha||''}</td>
        <td>${escapeHtml(d.titulo)}</td>
        <td>${escapeHtml(d.fornecedor)}</td>
        <td>${escapeHtml(d.tipo_risco)}</td>
        <td>${escapeHtml(d.pais_origem)}</td>
        <td>${escapeHtml(d.produto)}</td>
        <td>${d.total_afetado.toLocaleString('pt-BR')}</td>
        <td>${d.total_atendido.toLocaleString('pt-BR')}</td>
        <td>${d.perc_atendido}%</td>
      </tr>
    `).join('');
    document.getElementById('contador').innerText = `Total de registros: ${dados.length}`;
    if($.fn.DataTable.isDataTable('#tblRecall')) $('#tblRecall').DataTable().clear().destroy();
    $('#tblRecall').DataTable({pageLength:10,responsive:true,order:[[0,'asc']],language:{url:"https://cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"}});
  }

  function agrupar(dados,campo){
    return dados.reduce((acc,d)=>{ const chave=d[campo]||'(Sem valor)'; acc[chave]=(acc[chave]||0)+1; return acc; },{});
  }

  function escapeHtml(text){ if(!text && text!==0) return ''; return String(text).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  [selAno, selFornecedor, selPais].forEach(sel => sel.addEventListener('change', () => atualizarTudo(obterFiltrados())));
  btnLimpar.addEventListener('click', ()=>{ selAno.value=''; selFornecedor.value=''; selPais.value=''; atualizarTudo(baseDados); });
  document.getElementById('btnIA').addEventListener('click', ()=> gerarAnaliseIA(obterFiltrados()));

  window.addEventListener("DOMContentLoaded", carregarDados);

})();

// --- IA Gemini via servidor ---
async function gerarAnaliseIA(dados){
  const containerIA = document.getElementById('analise-ia');
  containerIA.innerHTML = '<em>üß† Gerando resumo inteligente...<span class="loader"></span></em>';

  try {
    // 1Ô∏è‚É£ Pega a chave do servidor
    const chaveRes = await fetch("/api/key");
    const { key: GEMINI_API_KEY } = await chaveRes.json();

    const resumo = dados.slice(0,50).map(d=>({
      fornecedor:d.fornecedor,
      tipo_risco:d.tipo_risco,
      pais:d.pais_origem,
      afetados:d.total_afetado,
      atendidos:d.total_atendido
    }));

    const prompt = `Gere um resumo anal√≠tico e interpretativo dos dados de recall abaixo, destacando:
      - fornecedores com mais recalls
      - tipos de risco mais frequentes
      - pa√≠ses com maior incid√™ncia
      - oportunidades de melhoria.
      Seja conciso, objetivo e use portugu√™s claro.
      Dados:
      ${JSON.stringify(resumo,null,2)}
    `;

    const resposta = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
      { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({contents:[{role:"user",parts:[{text:prompt}]}]}) }
    );

    const json = await resposta.json();
    const texto = json.candidates?.[0]?.content?.parts?.[0]?.text || "N√£o foi poss√≠vel gerar o resumo.";

    containerIA.innerHTML = `<h3>üß† Resumo Inteligente (Gemini)</h3><p>${texto.replace(/\n/g,'<br>')}</p>`;
  } catch(err){
    console.error(err);
    containerIA.innerHTML = '<p style="color:red;">Erro ao gerar resumo inteligente com Gemini.</p>';
  }
}
</script>
</body>
</html>
